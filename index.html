<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ä¸­é»é¤ç³»çµ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    /* æ¨£å¼å€ */
    :root { --primary-color: #7c9cbf; --primary-dark: #5e86a9; --secondary-color: #f6ae99; --accent-color: #98c9b2; --background-color: #f9f9f9; --card-bg: #ffffff; --text-color: #4a4a4a; --text-light: #8b99a6; --border-color: #e9ecef; --success-color: #98c9b2; --danger-color: #e5989b; --shadow: 0 8px 30px rgba(0, 0, 0, 0.04); --radius: 20px; --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    
    .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: 0.3s; overflow: hidden; }
    .fullscreen-overlay.active { opacity: 1; visibility: visible; }
    .fullscreen-image-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
    .fullscreen-image-container:active { cursor: grabbing; }
    .fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; transition: transform 0.1s ease-out; transform-origin: center center; }
    .zoom-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10001; }
    .control-btn { color: white; font-size: 1.2rem; cursor: pointer; width: 45px; height: 45px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.3); transition: 0.2s; }
    .control-btn:hover { background: var(--primary-color); border-color: var(--primary-color); }
    .close-btn { background: rgba(229, 152, 155, 0.8); }
    .close-btn:hover { background: var(--danger-color); }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 8000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; display: flex; flex-direction: column; }
    .store-checkbox-list { overflow-y: auto; margin: 10px 0; border: 1px solid #eee; padding: 10px; border-radius: 10px; flex: 1; }
    .store-checkbox-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0; }
    .store-checkbox-item:last-child { border-bottom: none; }
    .store-checkbox-item input { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--primary-color); }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.6; background-color: var(--background-color); color: var(--text-color); }
    .container { max-width: 1320px; margin: 0 auto; padding: 40px 20px; }
    header { display: flex; flex-direction: column; align-items: center; margin-bottom: 50px; }
    .app-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; text-align: center; }
    #datetime { font-size: 1.1rem; color: var(--text-light); padding: 8px 20px; background: var(--card-bg); border-radius: 30px; box-shadow: var(--shadow); }
    .content-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 35px; margin-bottom: 45px; }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; border: 1px solid rgba(230, 230, 230, 0.5); }
    .card-header { display: flex; align-items: center; margin-bottom: 25px; }
    .card-icon { font-size: 1.7rem; color: var(--primary-color); margin-right: 15px; background: rgba(124, 156, 191, 0.1); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .card-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin: 0; }
    .form-group { margin-bottom: 22px; }
    label { display: block; margin-bottom: 8px; color: var(--text-light); }
    input, textarea, select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 14px; font-size: 1rem; background: var(--background-color); }
    .btn { padding: 14px 24px; border: none; border-radius: 16px; font-size: 1rem; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 10px; }
    .btn-icon { margin-right: 10px; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-3px); }
    .btn-secondary { background: var(--secondary-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    
    .store-selector { margin-bottom: 20px; }
    .store-selector select { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); border: 2px solid var(--primary-color); }
    .search-box { position: relative; margin-bottom: 10px; }
    .search-box input { padding-left: 40px; border: 2px solid #ddd; transition: 0.3s; width: 100%; }
    .search-box input:focus { border-color: var(--primary-color); }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }

    .menu-display-area { position: relative; background: #f3f4f6; border-radius: var(--radius); min-height: 300px; display: flex; justify-content: center; align-items: center; overflow: hidden; margin-bottom: 15px; border: 1px solid #eee; }
    .menu-display-area img { max-width: 100%; max-height: 600px; object-fit: contain; cursor: pointer; }
    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; transition: 0.2s; z-index: 10; }
    .nav-btn:hover { background: var(--primary-color); }
    .nav-prev { left: 10px; }
    .nav-next { right: 10px; }
    .page-indicator { text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--primary-color); }
    
    .menu-actions { display: flex; flex-direction: column; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; }
    .action-row { display: flex; gap: 10px; align-items: center; }

    table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 25px; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background: var(--primary-color); color: white; }
    .checkbox-cell { text-align: center; width: 40px; }
    .total-section { display: flex; justify-content: flex-end; margin: 25px 0; }
    #totalPrice { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); background: var(--card-bg); padding: 12px 25px; border-radius: 20px; box-shadow: var(--shadow); }
    .glass-effect { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; }
    .toast { padding: 16px 24px; border-radius: 18px; margin-bottom: 16px; color: white; box-shadow: 0 8px 30px rgba(0,0,0,0.1); animation: slideIn 0.3s ease forwards; background: rgba(152, 201, 178, 0.9); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    /* æ—¥æœŸåˆ†éš”ç·šæ¨£å¼ */
    .date-header { background-color: #eef5f9; color: #5e86a9; font-weight: bold; text-align: center; border-top: 3px solid #7c9cbf; }
    /* èˆŠè¨‚å–®æ¨£å¼ (è®Šæ·¡) */
    .past-order { color: #aaa; }
    
    @media (max-width: 768px) { .content-wrapper { grid-template-columns: 1fr; } table { font-size: 0.9rem; } th, td { padding: 8px; } .action-row { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="app-title">å°ä¸­é»é¤ç³»çµ±</h1>
      <div id="datetime" class="glass-effect"></div>
    </header>

    <div class="content-wrapper">
      <div class="card glass-effect">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-utensils"></i></div>
          <h2 class="card-title">æˆ‘è¦é»é¤</h2>
        </div>
        <form id="orderForm">
          <div style="margin-bottom: 15px; padding: 10px; background: #eef5f9; border-radius: 10px; color: var(--primary-dark); font-weight: bold;">
             <i class="fas fa-store"></i> è¨‚è³¼åº—å®¶ï¼š<span id="displayStoreName">è«‹å…ˆé¸æ“‡å³æ–¹èœå–®</span>
          </div>
          
          <div class="form-group"><label>æ‚¨çš„å§“å</label><input type="text" id="name" required placeholder="ä¾‹å¦‚ï¼šå°æ˜"></div>
          <div class="form-group"><label>é¤é»åç¨±</label><input type="text" id="meal" required placeholder="ä¾‹å¦‚ï¼šçå¥¶åŠç³–å¾®å†°"></div>
          <div class="form-group"><label>åƒ¹æ ¼</label><input type="number" id="price" required placeholder="ä¾‹å¦‚ï¼š60"></div>
          <div class="form-group"><label>å‚™è¨»</label><textarea id="note" rows="2" placeholder="å‚™è¨»äº‹é …"></textarea></div>
          <button type="submit" id="submitOrderBtn" class="btn btn-primary" disabled><i class="fas fa-paper-plane btn-icon"></i>é€å‡ºè¨‚å–®</button>
        </form>
      </div>

      <div class="card glass-effect">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-clipboard-list"></i></div>
          <h2 class="card-title">åº—å®¶èœå–®</h2>
          <button class="btn btn-secondary" style="width: auto; margin-left: auto; font-size: 0.9rem; padding: 5px 15px;" onclick="openStoreSelector()">
            <i class="fas fa-cog"></i> è¨­å®šä»Šæ—¥åº—å®¶
          </button>
        </div>

        <div id="dailyStoreInfo" style="margin-bottom: 10px; color: #e5989b; font-weight: bold; display: none;">
            <i class="fas fa-bullhorn"></i> ä»Šæ—¥é™å®šï¼š<span id="dailyStoreList"></span>
        </div>

        <div class="store-selector">
            <label><i class="fas fa-filter"></i> é¸æ“‡åº—å®¶èœå–®ï¼š</label>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="storeSearchInput" placeholder="è¼¸å…¥é—œéµå­—æœå°‹åº—å®¶..." autocomplete="off">
            </div>
            <select id="storeSelect">
                <option value="">-- ç›®å‰æ²’æœ‰èœå–® --</option>
            </select>
        </div>
        
        <div class="menu-display-area">
            <button class="nav-btn nav-prev" onclick="prevMenuPage()"><i class="fas fa-chevron-left"></i></button>
            <img id="currentMenuImg" src="" alt="èœå–®" style="display:none;" title="é»æ“Šå¯æ”¾å¤§ç€è¦½" />
            <div id="noMenuText" style="color: #8b99a6; text-align: center;">æš«ç„¡æ­¤åº—å®¶çš„åœ–ç‰‡</div>
            <button class="nav-btn nav-next" onclick="nextMenuPage()"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div id="pageIndicator" class="page-indicator">ç¬¬ 0 / 0 é </div>
        
        <div style="text-align:center; margin-bottom:15px;">
             <button id="deleteCurrentPageBtn" class="btn btn-danger btn-sm" style="display:none; width:auto;" onclick="deleteCurrentMenuPage()">
                <i class="fas fa-trash-alt btn-icon"></i>åˆªé™¤ç›®å‰é€™é 
            </button>
        </div>

        <div class="menu-actions">
            <div class="form-group" style="margin-bottom:10px;">
                <label style="color:#7c9cbf; font-weight:bold;">1. è¼¸å…¥åº—å®¶åç¨± (æ–°å¢æ™‚å¿…å¡«)</label>
                <input type="text" id="newStoreNameInput" placeholder="ä¾‹å¦‚ï¼š50åµã€éº¥ç•¶å‹" style="border: 2px solid #7c9cbf;">
            </div>

            <div style="font-size:0.9rem; font-weight:bold; color:#666;">2. é¸æ“‡ä¸Šå‚³æ–¹å¼</div>
            
            <div class="action-row">
                <input type="text" id="menuUrlInput" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€..." style="flex:2;">
                <button id="addUrlBtn" class="btn btn-primary" style="flex:1; margin-bottom:0;">
                    <i class="fas fa-link btn-icon"></i>å­˜ç¶²å€
                </button>
            </div>
            
            <div style="text-align:center; font-size:0.8rem; color:#888;">æˆ–æ˜¯</div>

            <div class="action-row">
                <button id="changeImageButton" class="btn btn-secondary" style="width:100%; margin-bottom:0;">
                    <i class="fas fa-upload btn-icon"></i>é›»è…¦ä¸Šå‚³åœ–ç‰‡ (950KB)
                </button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
        </div>
      </div>
    </div>

    <div class="card glass-effect">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-list-alt"></i></div>
        <h2 class="card-title">é»é¤ç´€éŒ„ <span style="font-size:0.5em; color:#999; vertical-align:middle;">(è‡ªå‹•åˆ†çµ„)</span></h2>
      </div>
      <div style="overflow-x:auto;">
        <table id="orderTable">
          <thead>
            <tr>
              <th class="checkbox-cell">é¸</th>
              <th>No.</th>
              <th>åº—å®¶</th>
              <th>å§“å</th>
              <th>é¤é»</th>
              <th>åƒ¹æ ¼</th>
              <th>æ™‚é–“</th>
              <th>å‚™è¨»</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="total-section">
        <div id="totalPrice">ä»Šæ—¥ç¸½é‡‘é¡: $0</div>
      </div>
      
      <div style="background: #f1f5f9; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #ddd;">
          <h4 style="margin-bottom: 10px; color: var(--primary-dark);"><i class="fas fa-tools"></i> çµå¸³èˆ‡ç¶­è­·</h4>
          
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
              <span style="font-weight:bold; color:#555;">åŒ¯å‡ºå€é–“ï¼š</span>
              <input type="date" id="exportStartDate" style="flex:1;">
              <span>è‡³</span>
              <input type="date" id="exportEndDate" style="flex:1;">
              <button id="exportRangeButton" class="btn btn-primary" style="flex:1; margin-bottom:0; background: #27ae60;">
                  <i class="fas fa-file-excel"></i> åŒ¯å‡º Excel
              </button>
          </div>

          <div style="border-top: 1px dashed #ccc; padding-top: 15px; display:flex; justify-content: flex-end;">
              <button id="cleanupOldDataBtn" class="btn btn-danger" style="width: auto; margin-bottom:0; font-size:0.9rem;" title="åªæœƒåˆªé™¤30å¤©å‰çš„è³‡æ–™">
                  <i class="fas fa-trash-restore"></i> æ¸…é™¤ 30 å¤©å‰çš„èˆŠè³‡æ–™ (ç˜¦èº«)
              </button>
          </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="deleteSelectedButton" class="btn btn-secondary" style="flex:1;">åˆªé™¤é¸å–</button>
        <button id="clearButton" class="btn btn-danger" style="flex:1;">å…¨éƒ¨æ¸…ç©º (ä»Šæ—¥)</button>
      </div>
    </div>
  </div>

  <div class="toast-container"></div>
  
  <div id="fullscreenOverlay" class="fullscreen-overlay">
    <div class="zoom-controls">
        <div class="control-btn" id="zoomInBtn" title="æ”¾å¤§"><i class="fas fa-plus"></i></div>
        <div class="control-btn" id="zoomOutBtn" title="ç¸®å°"><i class="fas fa-minus"></i></div>
        <div class="control-btn" id="zoomResetBtn" title="é‚„åŸ"><i class="fas fa-compress"></i></div>
        <div class="control-btn close-btn" id="closeFullscreen" title="é—œé–‰"><i class="fas fa-times"></i></div>
    </div>
    <div class="fullscreen-image-container" id="imgContainer">
        <img id="fullscreenImage" class="fullscreen-image" src="" />
    </div>
  </div>

  <div id="storeModal" class="modal-overlay">
      <div class="modal-card">
          <h2 style="color:var(--primary-color); margin-bottom:15px;">è¨­å®šä»Šæ—¥åº—å®¶</h2>
          <p style="color:#666; font-size:0.9rem; margin-bottom: 10px;">è«‹å‹¾é¸ä»Šå¤©è¦é–‹æ”¾çš„åº—å®¶ï¼š</p>
          <div class="search-box" style="margin-bottom: 10px;">
              <i class="fas fa-search"></i>
              <input type="text" id="storeSelectorSearchInput" placeholder="æœå°‹åº—å®¶åç¨±..." autocomplete="off">
          </div>
          <div id="storeCheckboxList" class="store-checkbox-list"></div>
          <div style="display:flex; gap:10px; margin-top: 10px;">
              <button class="btn btn-primary" onclick="saveDailyStores()">å„²å­˜è¨­å®š</button>
              <button class="btn btn-secondary" style="background:#ccc;" onclick="closeStoreSelector()">å–æ¶ˆ</button>
          </div>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQ6dico4o8QYUTEwqPs378QG5D3o_4htc",
      authDomain: "taichung-order.firebaseapp.com",
      projectId: "taichung-order",
      storageBucket: "taichung-order.firebasestorage.app",
      messagingSenderId: "366278670573",
      appId: "1:366278670573:web:fc1762da58ed7b7b4434e4",
      measurementId: "G-WR6L5NHZE6"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      console.log("Firebase é€£ç·šæˆåŠŸ");
      showToast("ç³»çµ±é€£ç·šæˆåŠŸï¼");
      listenToOrders(); 
      listenToMenuImages(); 
      listenToDailySettings(); 
      initDatePickers(); 
    } catch (e) {
      console.error(e);
      alert("é€£ç·šå¤±æ•—ï¼" + e.message);
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = now.toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
      });
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    function initDatePickers() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('exportEndDate').value = today;
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        document.getElementById('exportStartDate').value = lastWeek.toISOString().split('T')[0];
    }

    function listenToOrders() {
      const db = firebase.firestore();
      db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        const tbody = document.querySelector('#orderTable tbody');
        let htmlContent = '';
        let todayTotal = 0;
        let index = snapshot.docs.length; 
        
        let lastDateHeader = null; 
        const todayStr = new Date().toLocaleDateString('zh-TW');

        snapshot.docs.forEach((doc) => {
          const data = doc.data();
          const dateObj = new Date(data.timestamp);
          const dateStr = dateObj.toLocaleDateString('zh-TW'); 
          
          if (dateStr !== lastDateHeader) {
              const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
              const dayName = dayNames[dateObj.getDay()];
              htmlContent += `
                <tr class="date-header">
                    <td colspan="8">ğŸ“… ${dateStr} (${dayName})</td>
                </tr>
              `;
              lastDateHeader = dateStr;
          }

          const isToday = (dateStr === todayStr);
          if (isToday) todayTotal += Number(data.price);

          const timeStr = dateObj.toLocaleString('zh-TW', {hour: '2-digit', minute: '2-digit', hour12: false});
          const storeDisplay = data.storeName ? `<span style="background:#eef5f9; padding:2px 6px; border-radius:4px; color:#5e86a9; font-size:0.9em;">${data.storeName}</span>` : '<span style="color:#ccc;">-</span>';
          
          const rowClass = isToday ? '' : 'past-order';

          htmlContent += `
            <tr class="${rowClass}">
              <td class="checkbox-cell"><input type="checkbox" data-id="${doc.id}"></td>
              <td>${index--}</td>
              <td>${storeDisplay}</td>
              <td>${data.name}</td>
              <td>${data.meal}</td>
              <td>$${data.price}</td>
              <td style="font-size:0.9em;">${timeStr}</td>
              <td style="font-size:0.9em;">${data.note || ''}</td>
            </tr>
          `;
        });

        tbody.innerHTML = htmlContent;
        document.getElementById('totalPrice').textContent = `ä»Šæ—¥ç¸½é‡‘é¡: $${todayTotal}`;
      });
    }

    document.getElementById('orderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const currentStore = document.getElementById('storeSelect').value;
      if (!currentStore) return alert("è«‹å…ˆåœ¨å³å´é¸æ“‡ä¸€å®¶é¤å»³èœå–®ï¼");
      const db = firebase.firestore();
      db.collection("orders").add({
        storeName: currentStore, 
        name: document.getElementById('name').value,
        meal: document.getElementById('meal').value,
        price: Number(document.getElementById('price').value),
        note: document.getElementById('note').value,
        paid: false,
        timestamp: Date.now()
      }).then(() => {
        document.getElementById('name').value = ''; 
        document.getElementById('meal').value = '';
        document.getElementById('price').value = '';
        document.getElementById('note').value = '';
        showToast("è¨‚å–®å·²é€å‡ºï¼");
      }).catch(err => alert("é€å‡ºå¤±æ•—: " + err.message));
    });

    document.getElementById('exportRangeButton').addEventListener('click', () => {
        const startDateStr = document.getElementById('exportStartDate').value;
        const endDateStr = document.getElementById('exportEndDate').value;
        if(!startDateStr || !endDateStr) return alert("è«‹é¸æ“‡å®Œæ•´çš„é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
        const startTs = new Date(startDateStr).setHours(0,0,0,0);
        const endTs = new Date(endDateStr).setHours(23,59,59,999);
        showToast("æ­£åœ¨å¾è³‡æ–™åº«æŠ“å–è³‡æ–™...", "info");
        firebase.firestore().collection("orders")
            .where("timestamp", ">=", startTs)
            .where("timestamp", "<=", endTs)
            .orderBy("timestamp", "desc")
            .get()
            .then(snapshot => {
                if(snapshot.empty) return alert("é€™æ®µæœŸé–“æ²’æœ‰ä»»ä½•è¨‚å–®è³‡æ–™å–”ï¼");
                let csv = "\uFEFFè¨‚å–®æ™‚é–“,åº—å®¶,å§“å,é¤é»,åƒ¹æ ¼,å‚™è¨»\n"; 
                let sum = 0;
                snapshot.docs.forEach(doc => {
                    const d = doc.data();
                    const dateObj = new Date(d.timestamp);
                    const timeStr = `${dateObj.getFullYear()}/${(dateObj.getMonth()+1).toString().padStart(2,'0')}/${dateObj.getDate().toString().padStart(2,'0')} ${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}`;
                    const safeName = (d.name || "").replace(/,/g, " ");
                    const safeMeal = (d.meal || "").replace(/,/g, " ");
                    const safeNote = (d.note || "").replace(/,/g, " ");
                    const safeStore = (d.storeName || "").replace(/,/g, " ");
                    csv += `${timeStr},${safeStore},${safeName},${safeMeal},${d.price},${safeNote}\n`;
                    sum += Number(d.price || 0);
                });
                csv += `\n,,,,,ç¸½è¨ˆ: $${sum}\n`;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `è¨‚å–®åŒ¯å‡º_${startDateStr}_to_${endDateStr}.csv`;
                link.click();
                showToast(`åŒ¯å‡ºæˆåŠŸï¼å€é–“ç¸½é¡ $${sum}`);
            })
            .catch(err => { console.error(err); alert("åŒ¯å‡ºå¤±æ•—ï¼š" + err.message); });
    });

    document.getElementById('cleanupOldDataBtn').addEventListener('click', () => {
        const pwd = prompt("é€™æœƒåˆªé™¤ã€Œ30å¤©å‰ã€çš„æ‰€æœ‰è¨‚å–®ï¼Œç¢ºå®šå—ï¼Ÿ\nè«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼š");
        // MjI5MQ== is '2291'
        if (btoa(pwd) !== 'MjI5MQ==') return alert("å¯†ç¢¼éŒ¯èª¤");

        const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
        showToast("æ­£åœ¨æ¸…ç†èˆŠè³‡æ–™...", "info");
        const db = firebase.firestore();
        db.collection("orders").where("timestamp", "<", thirtyDaysAgo).get()
          .then(snapshot => {
              if (snapshot.empty) return alert("æ²’æœ‰ 30 å¤©å‰çš„èˆŠè³‡æ–™å¯ä»¥åˆªé™¤ã€‚");
              const batch = db.batch();
              snapshot.docs.forEach(doc => batch.delete(doc.ref));
              return batch.commit().then(() => { alert(`æˆåŠŸåˆªé™¤äº† ${snapshot.size} ç­†èˆŠè³‡æ–™ï¼è³‡æ–™åº«ç˜¦èº«å®Œæˆã€‚`); });
          })
          .catch(err => alert("æ¸…ç†å¤±æ•—: " + err.message));
    });

    let allMenuData = []; 
    let currentStoreImages = []; 
    let currentMenuIndex = 0; 
    let dailyStores = []; 

    function listenToMenuImages() { 
        firebase.firestore().collection("menu_images").orderBy("timestamp", "asc").onSnapshot(snapshot => { 
            allMenuData = []; 
            snapshot.forEach(doc => { 
                allMenuData.push({ id: doc.id, ...doc.data() }); 
            }); 
            updateStoreDropdown(); 
        }); 
    }

    function listenToDailySettings() { 
        firebase.firestore().collection("settings").doc("daily").onSnapshot(doc => { 
            if (doc.exists && doc.data().activeStores) { 
                dailyStores = doc.data().activeStores; 
                const infoDiv = document.getElementById('dailyStoreInfo'); 
                const listSpan = document.getElementById('dailyStoreList'); 
                if (dailyStores.length > 0) { 
                    infoDiv.style.display = 'block'; 
                    listSpan.innerText = dailyStores.join('ã€'); 
                } else { 
                    infoDiv.style.display = 'none'; 
                } 
            } else { 
                dailyStores = []; 
            } 
            updateStoreDropdown(); 
        }); 
    }

    function updateStoreDropdown(searchTerm = "") {
      const select = document.getElementById('storeSelect'); 
      const currentVal = select.value; 
      const storeSet = new Set(); 
      allMenuData.forEach(d => { if(d.storeName) storeSet.add(d.storeName); }); 
      let stores = Array.from(storeSet);
      if (dailyStores.length > 0) { stores = stores.filter(s => dailyStores.includes(s)); }
      if (searchTerm) { stores = stores.filter(s => s.toLowerCase().includes(searchTerm.toLowerCase())); }
      
      select.innerHTML = '';
      if (stores.length === 0) { 
          if(dailyStores.length > 0) select.innerHTML = '<option value="">-- ä»Šæ—¥æœªé–‹æ”¾æ­¤åº—å®¶ --</option>'; 
          else select.innerHTML = '<option value="">-- æ‰¾ä¸åˆ°åº—å®¶ --</option>'; 
      } else { 
          stores.forEach(store => { 
              const opt = document.createElement('option'); 
              opt.value = store; 
              opt.innerText = store; 
              select.appendChild(opt); 
          }); 
          if (stores.includes(currentVal)) { select.value = currentVal; } 
          else if (stores.length > 0) { select.value = stores[0]; filterMenuByStore(); } 
      }
      if(stores.length === 0) { 
          document.getElementById('displayStoreName').innerText = "ç„¡åº—å®¶"; 
          document.getElementById('submitOrderBtn').disabled = true; 
          currentStoreImages = []; 
          renderCurrentMenu(); 
      }
    }

    document.getElementById('storeSearchInput').addEventListener('input', (e) => { 
        const term = e.target.value.trim(); 
        updateStoreDropdown(term); 
    });

    document.getElementById('storeSelect').addEventListener('change', () => { filterMenuByStore(); });

    function filterMenuByStore() { 
        const select = document.getElementById('storeSelect'); 
        const selectedStore = select.value; 
        if (!selectedStore) { 
            currentStoreImages = []; 
            document.getElementById('displayStoreName').innerText = "ç„¡åº—å®¶"; 
            document.getElementById('submitOrderBtn').disabled = true; 
        } else { 
            currentStoreImages = allMenuData.filter(d => d.storeName === selectedStore); 
            document.getElementById('displayStoreName').innerText = selectedStore; 
            document.getElementById('displayStoreName').style.color = "#e67e22"; 
            document.getElementById('submitOrderBtn').disabled = false; 
        } 
        currentMenuIndex = 0; 
        renderCurrentMenu(); 
    }

    function renderCurrentMenu() { 
        const imgEl = document.getElementById('currentMenuImg'); 
        const noText = document.getElementById('noMenuText'); 
        const indicator = document.getElementById('pageIndicator'); 
        const delBtn = document.getElementById('deleteCurrentPageBtn'); 
        const navPrev = document.querySelector('.nav-prev'); 
        const navNext = document.querySelector('.nav-next'); 
        if (currentStoreImages.length === 0) { 
            imgEl.style.display = 'none'; 
            imgEl.src = ''; 
            noText.style.display = 'block'; 
            indicator.textContent = 'ç¬¬ 0 / 0 é '; 
            delBtn.style.display = 'none'; 
            navPrev.style.display = 'none'; 
            navNext.style.display = 'none'; 
        } else { 
            const data = currentStoreImages[currentMenuIndex]; 
            imgEl.src = data.url; 
            imgEl.style.display = 'block'; 
            noText.style.display = 'none'; 
            indicator.textContent = `ç¬¬ ${currentMenuIndex + 1} / ${currentStoreImages.length} é `; 
            delBtn.style.display = 'inline-block'; 
            navPrev.style.display = 'flex'; 
            navNext.style.display = 'flex'; 
        } 
    }

    window.prevMenuPage = function() { 
        if (currentStoreImages.length > 0) { 
            currentMenuIndex = (currentMenuIndex - 1 + currentStoreImages.length) % currentStoreImages.length; 
            renderCurrentMenu(); 
        } 
    }

    window.nextMenuPage = function() { 
        if (currentStoreImages.length > 0) { 
            currentMenuIndex = (currentMenuIndex + 1) % currentStoreImages.length; 
            renderCurrentMenu(); 
        } 
    }

    window.deleteCurrentMenuPage = function() { 
        if (currentStoreImages.length === 0) return; 
        const pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼"); 
        if (btoa(pwd) !== 'MjI5MQ==') return alert("å¯†ç¢¼éŒ¯èª¤"); 
        const docId = currentStoreImages[currentMenuIndex].id; 
        firebase.firestore().collection("menu_images").doc(docId).delete()
            .then(() => showToast("å·²åˆªé™¤æ­¤é èœå–®"))
            .catch(err => alert("åˆªé™¤å¤±æ•—: " + err.message)); 
    }

    window.openStoreSelector = function() { 
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼"); 
        if (btoa(pwd) !== 'MjI5MQ==') return alert("å¯†ç¢¼éŒ¯èª¤"); 
        const listDiv = document.getElementById('storeCheckboxList'); 
        const searchInput = document.getElementById('storeSelectorSearchInput'); 
        listDiv.innerHTML = ''; 
        searchInput.value = ''; 
        const storeSet = new Set(); 
        allMenuData.forEach(d => { if(d.storeName) storeSet.add(d.storeName); }); 
        const allStores = Array.from(storeSet); 
        if (allStores.length === 0) { 
            listDiv.innerHTML = '<div style="text-align:center; color:#999;">ç›®å‰è³‡æ–™åº«æ²’æœ‰ä»»ä½•åº—å®¶</div>'; 
        } else { 
            allStores.forEach(store => { 
                const div = document.createElement('div'); 
                div.className = 'store-checkbox-item'; 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                checkbox.value = store; 
                if (dailyStores.includes(store)) checkbox.checked = true; 
                const label = document.createElement('label'); 
                label.innerText = store; 
                label.style.marginBottom = '0'; 
                label.style.cursor = 'pointer'; 
                label.onclick = () => checkbox.click(); 
                div.appendChild(checkbox); 
                div.appendChild(label); 
                listDiv.appendChild(div); 
            }); 
        } 
        document.getElementById('storeModal').classList.add('open'); 
    }

    document.getElementById('storeSelectorSearchInput').addEventListener('input', function(e) { 
        const term = e.target.value.toLowerCase(); 
        const items = document.querySelectorAll('.store-checkbox-item'); 
        items.forEach(item => { 
            const text = item.innerText.toLowerCase(); 
            if (term === '' || text.includes(term)) { 
                item.style.display = 'flex'; 
            } else { 
                item.style.display = 'none'; 
            } 
        }); 
    });

    window.closeStoreSelector = function() { document.getElementById('storeModal').classList.remove('open'); }

    window.saveDailyStores = function() { 
        const checkboxes = document.querySelectorAll('#storeCheckboxList input[type="checkbox"]:checked'); 
        const selected = Array.from(checkboxes).map(cb => cb.value); 
        firebase.firestore().collection("settings").doc("daily").set({ activeStores: selected })
            .then(() => { 
                showToast("ä»Šæ—¥åº—å®¶è¨­å®šæˆåŠŸï¼"); 
                closeStoreSelector(); 
            })
            .catch(err => alert("å„²å­˜å¤±æ•—: " + err.message)); 
    }

    document.getElementById('addUrlBtn').addEventListener('click', () => { 
        const storeName = document.getElementById('newStoreNameInput').value.trim(); 
        const url = document.getElementById('menuUrlInput').value; 
        if (!storeName) return alert("è«‹å‹™å¿…è¼¸å…¥ã€Œåº—å®¶åç¨±ã€ï¼"); 
        if (!url) return alert("è«‹è²¼ä¸Šç¶²å€ï¼"); 
        showToast("æ–°å¢ä¸­...", "info"); 
        firebase.firestore().collection("menu_images").add({ 
            storeName: storeName, 
            url: url, 
            timestamp: Date.now() 
        })
        .then(() => { 
            showToast("æ–°å¢æˆåŠŸï¼"); 
            document.getElementById('menuUrlInput').value = ''; 
        })
        .catch(err => alert("æ–°å¢å¤±æ•—: " + err.message)); 
    });

    document.getElementById('changeImageButton').addEventListener('click', () => { 
        const storeName = document.getElementById('newStoreNameInput').value.trim(); 
        if (!storeName) return alert("è«‹å‹™å¿…è¼¸å…¥ã€Œåº—å®¶åç¨±ã€ï¼"); 
        document.getElementById('fileInput').click(); 
    });

    document.getElementById('fileInput').addEventListener('change', function(e) { 
        const storeName = document.getElementById('newStoreNameInput').value.trim(); 
        const file = e.target.files[0]; 
        if (!file) return; 
        if (file.size > 950 * 1024) { 
            return alert("åœ–ç‰‡è¶…é 950KBï¼è«‹æ”¹ç”¨ç¶²å€æˆ–å£“ç¸®å¾Œä¸Šå‚³ã€‚"); 
        } 
        showToast("åœ–ç‰‡ä¸Šå‚³ä¸­...", "info"); 
        const reader = new FileReader(); 
        reader.onload = function(event) { 
            const base64String = event.target.result; 
            firebase.firestore().collection("menu_images").add({ 
                storeName: storeName, 
                url: base64String, 
                timestamp: Date.now() 
            })
            .then(() => { showToast("ä¸Šå‚³æˆåŠŸï¼"); })
            .catch(err => alert("ä¸Šå‚³å¤±æ•—: " + err.message)); 
        }; 
        reader.readAsDataURL(file); 
    });

    document.getElementById('deleteSelectedButton').addEventListener('click', () => { 
        const checks = document.querySelectorAll('#orderTable input[type="checkbox"]:checked'); 
        if (checks.length === 0) return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®"); 
        const pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼"); 
        if (btoa(pwd) !== 'MjI5MQ==') return alert("å¯†ç¢¼éŒ¯èª¤"); 
        const batch = firebase.firestore().batch(); 
        checks.forEach(chk => { 
            batch.delete(firebase.firestore().collection("orders").doc(chk.dataset.id)); 
        }); 
        batch.commit().then(() => showToast("åˆªé™¤æˆåŠŸ")); 
    });

    document.getElementById('clearButton').addEventListener('click', () => { 
        if (!confirm("ç¢ºå®šè¦æ¸…ç©ºä»Šå¤©çš„è¨‚å–®å—ï¼Ÿ(èˆŠè³‡æ–™ä¸æœƒæ¶ˆå¤±)")) return; 
        const pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼"); 
        if (btoa(pwd) !== 'MjI5MQ==') return alert("å¯†ç¢¼éŒ¯èª¤"); 
        const checks = document.querySelectorAll('#orderTable input[type="checkbox"]'); 
        const batch = firebase.firestore().batch(); 
        checks.forEach(chk => { 
            batch.delete(firebase.firestore().collection("orders").doc(chk.dataset.id)); 
        }); 
        batch.commit().then(() => showToast("ä»Šæ—¥è¨‚å–®å·²æ¸…ç©º")); 
    });

    function showToast(msg, type="success") { 
        const container = document.querySelector('.toast-container'); 
        const div = document.createElement('div'); 
        div.className = 'toast'; 
        div.innerText = msg; 
        container.appendChild(div); 
        setTimeout(() => div.remove(), 3000); 
    }

    // åœ–ç‰‡ç¸®æ”¾èˆ‡æ‹–æ›³ (å®Œæ•´å±•é–‹ï¼Œé¿å…è¤‡è£½éŒ¯èª¤)
    let scale = 1; 
    let panning = false; 
    let pointX = 0; 
    let pointY = 0; 
    let startX = 0; 
    let startY = 0; 
    
    const imgOverlay = document.getElementById('fullscreenOverlay'); 
    const fullImg = document.getElementById('fullscreenImage'); 
    const container = document.getElementById('imgContainer'); 
    
    document.getElementById('currentMenuImg').addEventListener('click', function() { 
        if(this.src) { 
            fullImg.src = this.src; 
            imgOverlay.classList.add('active'); 
            resetZoom(); 
        } 
    }); 
    
    document.getElementById('closeFullscreen').addEventListener('click', () => { 
        imgOverlay.classList.remove('active'); 
    }); 
    
    function setTransform() { 
        fullImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; 
    } 
    
    function resetZoom() { 
        scale = 1; 
        pointX = 0; 
        pointY = 0; 
        setTransform(); 
    } 
    
    document.getElementById('zoomInBtn').onclick = () => { 
        scale += 0.2; 
        setTransform(); 
    } 
    
    document.getElementById('zoomOutBtn').onclick = () => { 
        if(scale > 0.4) scale -= 0.2; 
        setTransform(); 
    } 
    
    document.getElementById('zoomResetBtn').onclick = resetZoom; 
    
    container.addEventListener('wheel', (e) => { 
        e.preventDefault(); 
        const delta = e.deltaY * -0.001; 
        scale = Math.min(Math.max(.5, scale + delta), 4); 
        setTransform(); 
    }); 
    
    container.addEventListener('mousedown', (e) => { 
        e.preventDefault(); 
        startX = e.clientX - pointX; 
        startY = e.clientY - pointY; 
        panning = true; 
    }); 
    
    container.addEventListener('mouseup', () => { panning = false; }); 
    container.addEventListener('mouseleave', () => { panning = false; }); 
    
    container.addEventListener('mousemove', (e) => { 
        if (!panning) return; 
        e.preventDefault(); 
        pointX = e.clientX - startX; 
        pointY = e.clientY - startY; 
        setTransform(); 
    }); 
    
    container.addEventListener('touchstart', (e) => { 
        if(e.touches.length === 1) { 
            startX = e.touches[0].clientX - pointX; 
            startY = e.touches[0].clientY - pointY; 
            panning = true; 
        } 
    }); 
    
    container.addEventListener('touchend', () => { panning = false; }); 
    
    container.addEventListener('touchmove', (e) => { 
        if(!panning) return; 
        if(scale > 1) e.preventDefault(); 
        pointX = e.touches[0].clientX - startX; 
        pointY = e.touches[0].clientY - startY; 
        setTransform(); 
    });
  </script>
</body>
</html>
