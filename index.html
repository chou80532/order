<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台中點餐系統</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    /* 樣式區 */
    :root { --primary-color: #7c9cbf; --primary-dark: #5e86a9; --secondary-color: #f6ae99; --accent-color: #98c9b2; --background-color: #f9f9f9; --card-bg: #ffffff; --text-color: #4a4a4a; --text-light: #8b99a6; --border-color: #e9ecef; --success-color: #98c9b2; --danger-color: #e5989b; --shadow: 0 8px 30px rgba(0, 0, 0, 0.04); --radius: 20px; --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    
    /* 圖片瀏覽器樣式 */
    .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: 0.3s; overflow: hidden; }
    .fullscreen-overlay.active { opacity: 1; visibility: visible; }
    .fullscreen-image-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
    .fullscreen-image-container:active { cursor: grabbing; }
    .fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; transition: transform 0.1s ease-out; transform-origin: center center; }
    .zoom-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10001; }
    .control-btn { color: white; font-size: 1.2rem; cursor: pointer; width: 45px; height: 45px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.3); transition: 0.2s; }
    .control-btn:hover { background: var(--primary-color); border-color: var(--primary-color); }
    .close-btn { background: rgba(229, 152, 155, 0.8); }
    .close-btn:hover { background: var(--danger-color); }

    /* ★★★ 新增：今日店家設定視窗 ★★★ */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 8000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .store-checkbox-list { max-height: 300px; overflow-y: auto; margin: 20px 0; border: 1px solid #eee; padding: 10px; border-radius: 10px; }
    .store-checkbox-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0; }
    .store-checkbox-item:last-child { border-bottom: none; }
    .store-checkbox-item input { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--primary-color); }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.6; background-color: var(--background-color); color: var(--text-color); }
    .container { max-width: 1320px; margin: 0 auto; padding: 40px 20px; }
    header { display: flex; flex-direction: column; align-items: center; margin-bottom: 50px; }
    .app-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; text-align: center; }
    #datetime { font-size: 1.1rem; color: var(--text-light); padding: 8px 20px; background: var(--card-bg); border-radius: 30px; box-shadow: var(--shadow); }
    .content-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 35px; margin-bottom: 45px; }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; border: 1px solid rgba(230, 230, 230, 0.5); }
    .card-header { display: flex; align-items: center; margin-bottom: 25px; }
    .card-icon { font-size: 1.7rem; color: var(--primary-color); margin-right: 15px; background: rgba(124, 156, 191, 0.1); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .card-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin: 0; }
    .form-group { margin-bottom: 22px; }
    label { display: block; margin-bottom: 8px; color: var(--text-light); }
    input, textarea, select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 14px; font-size: 1rem; background: var(--background-color); }
    .btn { padding: 14px 24px; border: none; border-radius: 16px; font-size: 1rem; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 10px; }
    .btn-icon { margin-right: 10px; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-3px); }
    .btn-secondary { background: var(--secondary-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    
    .store-selector { margin-bottom: 20px; }
    .store-selector select { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); border: 2px solid var(--primary-color); }
    .search-box { position: relative; margin-bottom: 10px; }
    .search-box input { padding-left: 40px; border: 2px solid #ddd; transition: 0.3s; }
    .search-box input:focus { border-color: var(--primary-color); }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }

    .menu-display-area {
      position: relative;
      background: #f3f4f6;
      border-radius: var(--radius);
      min-height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      margin-bottom: 15px;
      border: 1px solid #eee;
    }
    .menu-display-area img { max-width: 100%; max-height: 600px; object-fit: contain; cursor: pointer; }
    .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; transition: 0.2s; z-index: 10; }
    .nav-btn:hover { background: var(--primary-color); }
    .nav-prev { left: 10px; }
    .nav-next { right: 10px; }
    .page-indicator { text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--primary-color); }
    
    .menu-actions { display: flex; flex-direction: column; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px solid #eee; }
    .action-row { display: flex; gap: 10px; align-items: center; }

    table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 25px; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background: var(--primary-color); color: white; }
    .checkbox-cell { text-align: center; width: 40px; }
    .paid-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--success-color); }
    .total-section { display: flex; justify-content: flex-end; margin: 25px 0; }
    #totalPrice { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); background: var(--card-bg); padding: 12px 25px; border-radius: 20px; box-shadow: var(--shadow); }
    .glass-effect { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; }
    .toast { padding: 16px 24px; border-radius: 18px; margin-bottom: 16px; color: white; box-shadow: 0 8px 30px rgba(0,0,0,0.1); animation: slideIn 0.3s ease forwards; background: rgba(152, 201, 178, 0.9); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @media (max-width: 768px) { .content-wrapper { grid-template-columns: 1fr; } table { font-size: 0.9rem; } th, td { padding: 8px; } .action-row { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="app-title">台中點餐系統</h1>
      <div id="datetime" class="glass-effect"></div>
    </header>

    <div class="content-wrapper">
      <div class="card glass-effect">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-utensils"></i></div>
          <h2 class="card-title">我要點餐</h2>
        </div>
        <form id="orderForm">
          <div style="margin-bottom: 15px; padding: 10px; background: #eef5f9; border-radius: 10px; color: var(--primary-dark); font-weight: bold;">
             <i class="fas fa-store"></i> 訂購店家：<span id="displayStoreName">請先選擇右方菜單</span>
          </div>
          
          <div class="form-group"><label>您的姓名</label><input type="text" id="name" required placeholder="例如：小明"></div>
          <div class="form-group"><label>餐點名稱</label><input type="text" id="meal" required placeholder="例如：珍奶半糖微冰"></div>
          <div class="form-group"><label>價格</label><input type="number" id="price" required placeholder="例如：60"></div>
          <div class="form-group"><label>備註</label><textarea id="note" rows="2" placeholder="備註事項"></textarea></div>
          <button type="submit" id="submitOrderBtn" class="btn btn-primary" disabled><i class="fas fa-paper-plane btn-icon"></i>送出訂單</button>
        </form>
      </div>

      <div class="card glass-effect">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-clipboard-list"></i></div>
          <h2 class="card-title">店家菜單</h2>
          <button class="btn btn-secondary" style="width: auto; margin-left: auto; font-size: 0.9rem; padding: 5px 15px;" onclick="openStoreSelector()">
            <i class="fas fa-cog"></i> 設定今日店家
          </button>
        </div>

        <div id="dailyStoreInfo" style="margin-bottom: 10px; color: #e5989b; font-weight: bold; display: none;">
            <i class="fas fa-bullhorn"></i> 今日限定：<span id="dailyStoreList"></span>
        </div>

        <div class="store-selector">
            <label><i class="fas fa-filter"></i> 選擇店家菜單：</label>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="storeSearchInput" placeholder="輸入關鍵字搜尋店家..." autocomplete="off">
            </div>
            <select id="storeSelect">
                <option value="">-- 目前沒有菜單 --</option>
            </select>
        </div>
        
        <div class="menu-display-area">
            <button class="nav-btn nav-prev" onclick="prevMenuPage()"><i class="fas fa-chevron-left"></i></button>
            <img id="currentMenuImg" src="" alt="菜單" style="display:none;" title="點擊可放大瀏覽" />
            <div id="noMenuText" style="color: #8b99a6; text-align: center;">暫無此店家的圖片</div>
            <button class="nav-btn nav-next" onclick="nextMenuPage()"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div id="pageIndicator" class="page-indicator">第 0 / 0 頁</div>
        
        <div style="text-align:center; margin-bottom:15px;">
             <button id="deleteCurrentPageBtn" class="btn btn-danger btn-sm" style="display:none; width:auto;" onclick="deleteCurrentMenuPage()">
                <i class="fas fa-trash-alt btn-icon"></i>刪除目前這頁
            </button>
        </div>

        <div class="menu-actions">
            <div class="form-group" style="margin-bottom:10px;">
                <label style="color:#7c9cbf; font-weight:bold;">1. 輸入店家名稱 (新增時必填)</label>
                <input type="text" id="newStoreNameInput" placeholder="例如：50嵐、麥當勞" style="border: 2px solid #7c9cbf;">
            </div>

            <div style="font-size:0.9rem; font-weight:bold; color:#666;">2. 選擇上傳方式</div>
            
            <div class="action-row">
                <input type="text" id="menuUrlInput" placeholder="貼上圖片網址..." style="flex:2;">
                <button id="addUrlBtn" class="btn btn-primary" style="flex:1; margin-bottom:0;">
                    <i class="fas fa-link btn-icon"></i>存網址
                </button>
            </div>
            
            <div style="text-align:center; font-size:0.8rem; color:#888;">或是</div>

            <div class="action-row">
                <button id="changeImageButton" class="btn btn-secondary" style="width:100%; margin-bottom:0;">
                    <i class="fas fa-upload btn-icon"></i>電腦上傳圖片 (950KB)
                </button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
        </div>
      </div>
    </div>

    <div class="card glass-effect">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-list-alt"></i></div>
        <h2 class="card-title">大家點了什麼</h2>
      </div>
      <div style="overflow-x:auto;">
        <table id="orderTable">
          <thead>
            <tr>
              <th class="checkbox-cell">選</th>
              <th>No.</th>
              <th>已繳費</th>
              <th>店家</th>
              <th>姓名</th>
              <th>餐點</th>
              <th>價格</th>
              <th>時間</th>
              <th>備註</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="total-section">
        <div id="totalPrice">總金額: $0</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="exportButton" class="btn btn-primary" style="flex:1;">匯出 Excel</button>
        <button id="deleteSelectedButton" class="btn btn-secondary" style="flex:1;">刪除選取</button>
        <button id="clearButton" class="btn btn-danger" style="flex:1;">全部清空</button>
      </div>
    </div>
  </div>

  <div class="toast-container"></div>
  
  <div id="fullscreenOverlay" class="fullscreen-overlay">
    <div class="zoom-controls">
        <div class="control-btn" id="zoomInBtn" title="放大"><i class="fas fa-plus"></i></div>
        <div class="control-btn" id="zoomOutBtn" title="縮小"><i class="fas fa-minus"></i></div>
        <div class="control-btn" id="zoomResetBtn" title="還原"><i class="fas fa-compress"></i></div>
        <div class="control-btn close-btn" id="closeFullscreen" title="關閉"><i class="fas fa-times"></i></div>
    </div>
    <div class="fullscreen-image-container" id="imgContainer">
        <img id="fullscreenImage" class="fullscreen-image" src="" />
    </div>
  </div>

  <div id="storeModal" class="modal-overlay">
      <div class="modal-card">
          <h2 style="color:var(--primary-color); margin-bottom:15px;">設定今日店家</h2>
          <p style="color:#666; font-size:0.9rem;">請勾選今天要開放的店家 (可多選)：</p>
          <div id="storeCheckboxList" class="store-checkbox-list">
              </div>
          <div style="display:flex; gap:10px;">
              <button class="btn btn-primary" onclick="saveDailyStores()">儲存設定</button>
              <button class="btn btn-secondary" style="background:#ccc;" onclick="closeStoreSelector()">取消</button>
          </div>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQ6dico4o8QYUTEwqPs378QG5D3o_4htc",
      authDomain: "taichung-order.firebaseapp.com",
      projectId: "taichung-order",
      storageBucket: "taichung-order.firebasestorage.app",
      messagingSenderId: "366278670573",
      appId: "1:366278670573:web:fc1762da58ed7b7b4434e4",
      measurementId: "G-WR6L5NHZE6"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      console.log("Firebase 連線成功");
      showToast("系統連線成功！");
      listenToOrders();
      listenToMenuImages(); 
      listenToDailySettings(); // 監聽今日店家設定
    } catch (e) {
      console.error(e);
      alert("連線失敗！" + e.message);
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = now.toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
      });
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // 訂單邏輯
    function listenToOrders() {
      const db = firebase.firestore();
      db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        const tbody = document.querySelector('#orderTable tbody');
        tbody.innerHTML = '';
        let total = 0;
        let index = snapshot.docs.length; 
        snapshot.docs.forEach((doc) => {
          const data = doc.data();
          const row = tbody.insertRow(0);
          
          let timeStr = "";
          if(data.timestamp){
            const dateObj = new Date(data.timestamp);
            timeStr = dateObj.toLocaleString('zh-TW', {month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false});
          }
          
          const storeDisplay = data.storeName ? `<span style="background:#eef5f9; padding:2px 6px; border-radius:4px; color:#5e86a9; font-size:0.9em;">${data.storeName}</span>` : '<span style="color:#ccc;">-</span>';

          row.innerHTML = `
            <td class="checkbox-cell"><input type="checkbox" data-id="${doc.id}"></td>
            <td>${index--}</td>
            <td style="text-align:center;">
              <input type="checkbox" class="paid-checkbox" ${data.paid ? 'checked' : ''} onchange="togglePaid('${doc.id}', this.checked)">
            </td>
            <td>${storeDisplay}</td>
            <td>${data.name}</td>
            <td>${data.meal}</td>
            <td>$${data.price}</td>
            <td style="font-size:0.9em; color:#666;">${timeStr}</td>
            <td style="color:#888; font-size:0.9em;">${data.note || ''}</td>
          `;
          total += Number(data.price);
        });
        document.getElementById('totalPrice').textContent = `總金額: $${total}`;
      });
    }

    document.getElementById('orderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const currentStore = document.getElementById('storeSelect').value;
      if (!currentStore) return alert("請先在右側選擇一家餐廳菜單！");
      const db = firebase.firestore();
      db.collection("orders").add({
        storeName: currentStore, 
        name: document.getElementById('name').value,
        meal: document.getElementById('meal').value,
        price: Number(document.getElementById('price').value),
        note: document.getElementById('note').value,
        paid: false,
        timestamp: Date.now()
      }).then(() => {
        document.getElementById('name').value = ''; 
        document.getElementById('meal').value = '';
        document.getElementById('price').value = '';
        document.getElementById('note').value = '';
        showToast("訂單已送出！");
      }).catch(err => alert("送出失敗: " + err.message));
    });

    window.togglePaid = function(id, isPaid) {
      firebase.firestore().collection("orders").doc(id).update({ paid: isPaid });
    }

    // 相簿邏輯
    let allMenuData = []; 
    let currentStoreImages = []; 
    let currentMenuIndex = 0;
    let dailyStores = []; // 今日限定店家列表

    function listenToMenuImages() {
      firebase.firestore().collection("menu_images").orderBy("timestamp", "asc").onSnapshot(snapshot => {
        allMenuData = [];
        snapshot.forEach(doc => {
          allMenuData.push({ id: doc.id, ...doc.data() });
        });
        updateStoreDropdown(); // 收到菜單後更新下拉
      });
    }

    // ★★★ 監聽今日設定 ★★★
    function listenToDailySettings() {
        firebase.firestore().collection("settings").doc("daily").onSnapshot(doc => {
            if (doc.exists && doc.data().activeStores) {
                dailyStores = doc.data().activeStores;
                
                // 更新 UI 顯示
                const infoDiv = document.getElementById('dailyStoreInfo');
                const listSpan = document.getElementById('dailyStoreList');
                if (dailyStores.length > 0) {
                    infoDiv.style.display = 'block';
                    listSpan.innerText = dailyStores.join('、');
                } else {
                    infoDiv.style.display = 'none';
                }
            } else {
                dailyStores = [];
            }
            updateStoreDropdown(); // 設定改變時，也要重新過濾下拉選單
        });
    }

    // 更新店家選單 (整合今日限定 + 搜尋)
    function updateStoreDropdown(searchTerm = "") {
      const select = document.getElementById('storeSelect');
      const currentVal = select.value;
      
      const storeSet = new Set();
      allMenuData.forEach(d => { if(d.storeName) storeSet.add(d.storeName); });
      let stores = Array.from(storeSet);
      
      // ★ 第一層過濾：如果是今日限定模式，只留下被勾選的店家
      if (dailyStores.length > 0) {
          stores = stores.filter(s => dailyStores.includes(s));
      }

      // ★ 第二層過濾：搜尋關鍵字
      if (searchTerm) {
        stores = stores.filter(s => s.toLowerCase().includes(searchTerm.toLowerCase()));
      }
      
      select.innerHTML = '';
      if (stores.length === 0) {
          if(dailyStores.length > 0) {
             select.innerHTML = '<option value="">-- 今日未開放此店家 --</option>';
          } else {
             select.innerHTML = '<option value="">-- 找不到店家 --</option>';
          }
      } else {
        stores.forEach(store => {
            const opt = document.createElement('option');
            opt.value = store;
            opt.innerText = store;
            select.appendChild(opt);
        });
        
        // 保持選中狀態
        if (stores.includes(currentVal)) { 
          select.value = currentVal; 
        } else if (stores.length > 0) {
          select.value = stores[0];
          filterMenuByStore(); // 自動切換
        }
      }
      
      if(stores.length === 0) {
          document.getElementById('displayStoreName').innerText = "無店家";
          document.getElementById('submitOrderBtn').disabled = true;
          currentStoreImages = [];
          renderCurrentMenu();
      }
    }

    // 搜尋框監聽
    document.getElementById('storeSearchInput').addEventListener('input', (e) => {
        const term = e.target.value.trim();
        updateStoreDropdown(term);
    });

    document.getElementById('storeSelect').addEventListener('change', () => {
        filterMenuByStore();
    });

    function filterMenuByStore() {
        const select = document.getElementById('storeSelect');
        const selectedStore = select.value;
        if (!selectedStore) {
            currentStoreImages = [];
            document.getElementById('displayStoreName').innerText = "無店家";
            document.getElementById('submitOrderBtn').disabled = true;
        } else {
            currentStoreImages = allMenuData.filter(d => d.storeName === selectedStore);
            document.getElementById('displayStoreName').innerText = selectedStore;
            document.getElementById('displayStoreName').style.color = "#e67e22";
            document.getElementById('submitOrderBtn').disabled = false;
        }
        currentMenuIndex = 0;
        renderCurrentMenu();
    }

    function renderCurrentMenu() {
      const imgEl = document.getElementById('currentMenuImg');
      const noText = document.getElementById('noMenuText');
      const indicator = document.getElementById('pageIndicator');
      const delBtn = document.getElementById('deleteCurrentPageBtn');
      const navPrev = document.querySelector('.nav-prev');
      const navNext = document.querySelector('.nav-next');

      if (currentStoreImages.length === 0) {
        imgEl.style.display = 'none';
        imgEl.src = '';
        noText.style.display = 'block';
        indicator.textContent = '第 0 / 0 頁';
        delBtn.style.display = 'none';
        navPrev.style.display = 'none';
        navNext.style.display = 'none';
      } else {
        const data = currentStoreImages[currentMenuIndex];
        imgEl.src = data.url;
        imgEl.style.display = 'block';
        noText.style.display = 'none';
        indicator.textContent = `第 ${currentMenuIndex + 1} / ${currentStoreImages.length} 頁`;
        delBtn.style.display = 'inline-block';
        navPrev.style.display = 'flex';
        navNext.style.display = 'flex';
      }
    }

    window.prevMenuPage = function() {
      if (currentStoreImages.length > 0) {
        currentMenuIndex = (currentMenuIndex - 1 + currentStoreImages.length) % currentStoreImages.length;
        renderCurrentMenu();
      }
    }

    window.nextMenuPage = function() {
      if (currentStoreImages.length > 0) {
        currentMenuIndex = (currentMenuIndex + 1) % currentStoreImages.length;
        renderCurrentMenu();
      }
    }

    window.deleteCurrentMenuPage = function() {
      if (currentStoreImages.length === 0) return;
      const pwd = prompt("請輸入密碼");
      if (btoa(pwd) !== 'MjI5MTM1Nzc=') return alert("密碼錯誤");

      const docId = currentStoreImages[currentMenuIndex].id;
      firebase.firestore().collection("menu_images").doc(docId).delete()
        .then(() => showToast("已刪除此頁菜單"))
        .catch(err => alert("刪除失敗: " + err.message));
    }

    // ★★★ 今日店家設定邏輯 ★★★
    window.openStoreSelector = function() {
        const pwd = prompt("請輸入管理者密碼");
        if (btoa(pwd) !== 'MjI5MTM1Nzc=') return alert("密碼錯誤");

        const listDiv = document.getElementById('storeCheckboxList');
        listDiv.innerHTML = '';

        // 找出所有店家
        const storeSet = new Set();
        allMenuData.forEach(d => { if(d.storeName) storeSet.add(d.storeName); });
        const allStores = Array.from(storeSet);

        if (allStores.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center; color:#999;">目前資料庫沒有任何店家</div>';
        } else {
            allStores.forEach(store => {
                const div = document.createElement('div');
                div.className = 'store-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = store;
                // 如果在今日名單中，預設打勾
                if (dailyStores.includes(store)) checkbox.checked = true;

                const label = document.createElement('label');
                label.innerText = store;
                label.style.marginBottom = '0';
                label.style.cursor = 'pointer';
                label.onclick = () => checkbox.click(); // 點字也可以勾

                div.appendChild(checkbox);
                div.appendChild(label);
                listDiv.appendChild(div);
            });
        }
        
        document.getElementById('storeModal').classList.add('open');
    }

    window.closeStoreSelector = function() {
        document.getElementById('storeModal').classList.remove('open');
    }

    window.saveDailyStores = function() {
        const checkboxes = document.querySelectorAll('#storeCheckboxList input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);
        
        firebase.firestore().collection("settings").doc("daily").set({
            activeStores: selected
        }).then(() => {
            showToast("今日店家設定成功！");
            closeStoreSelector();
        }).catch(err => alert("儲存失敗: " + err.message));
    }

    // 上傳邏輯
    document.getElementById('addUrlBtn').addEventListener('click', () => {
        const storeName = document.getElementById('newStoreNameInput').value.trim();
        const url = document.getElementById('menuUrlInput').value;
        if (!storeName) return alert("請務必輸入「店家名稱」！");
        if (!url) return alert("請貼上網址！");
        
        showToast("新增中...", "info");
        firebase.firestore().collection("menu_images").add({
            storeName: storeName, 
            url: url,
            timestamp: Date.now()
        })
        .then(() => {
            showToast("新增成功！");
            document.getElementById('menuUrlInput').value = '';
        })
        .catch(err => alert("新增失敗: " + err.message));
    });

    document.getElementById('changeImageButton').addEventListener('click', () => {
      const storeName = document.getElementById('newStoreNameInput').value.trim();
      if (!storeName) return alert("請務必輸入「店家名稱」！");
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const storeName = document.getElementById('newStoreNameInput').value.trim();
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 950 * 1024) { 
        alert("圖片超過 950KB！請改用網址或壓縮後上傳。");
        return;
      }
      showToast("圖片上傳中...", "info");
      const reader = new FileReader();
      reader.onload = function(event) {
        const base64String = event.target.result; 
        firebase.firestore().collection("menu_images").add({
          storeName: storeName, 
          url: base64String,
          timestamp: Date.now()
        })
        .then(() => { showToast("上傳成功！"); })
        .catch(err => alert("上傳失敗: " + err.message));
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('deleteSelectedButton').addEventListener('click', () => {
      const checks = document.querySelectorAll('#orderTable input[type="checkbox"]:checked');
      if (checks.length === 0) return alert("請先勾選要刪除的項目");
      const pwd = prompt("請輸入密碼");
      if (btoa(pwd) !== 'MjI5MTM1Nzc=') return alert("密碼錯誤");
      const batch = firebase.firestore().batch();
      checks.forEach(chk => {
        batch.delete(firebase.firestore().collection("orders").doc(chk.dataset.id));
      });
      batch.commit().then(() => showToast("刪除成功"));
    });

    document.getElementById('clearButton').addEventListener('click', () => {
      if (!confirm("確定要清空所有訂單嗎？")) return;
      const pwd = prompt("請輸入密碼");
      if (btoa(pwd) !== 'MjI5MTM1Nzc=') return alert("密碼錯誤");
      firebase.firestore().collection("orders").get().then(snapshot => {
        const batch = firebase.firestore().batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      }).then(() => showToast("全部清空成功"));
    });

    document.getElementById('exportButton').addEventListener('click', () => {
      let csv = "\uFEFFNo.,已繳費,店家,姓名,餐點,價格,時間,備註\n"; 
      const rows = document.querySelectorAll('#orderTable tbody tr');
      let i = rows.length;
      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        const paid = cols[2].querySelector('input').checked ? '是' : '否';
        csv += `${i--},${paid},${cols[3].innerText},${cols[4].innerText},${cols[5].innerText},${cols[6].innerText},${cols[7].innerText},${cols[8].innerText}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `orders_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    });

    function showToast(msg) {
      const container = document.querySelector('.toast-container');
      const div = document.createElement('div');
      div.className = 'toast';
      div.innerText = msg;
      container.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // 圖片縮放邏輯
    let scale = 1;
    let panning = false;
    let pointX = 0;
    let pointY = 0;
    let startX = 0;
    let startY = 0;
    const imgOverlay = document.getElementById('fullscreenOverlay');
    const fullImg = document.getElementById('fullscreenImage');
    const container = document.getElementById('imgContainer');

    document.getElementById('currentMenuImg').addEventListener('click', function() {
      if(this.src) {
        fullImg.src = this.src;
        imgOverlay.classList.add('active');
        resetZoom();
      }
    });

    document.getElementById('closeFullscreen').addEventListener('click', () => {
      imgOverlay.classList.remove('active');
    });

    function setTransform() {
      fullImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
    }

    function resetZoom() {
      scale = 1; pointX = 0; pointY = 0;
      setTransform();
    }

    document.getElementById('zoomInBtn').onclick = () => { scale += 0.2; setTransform(); }
    document.getElementById('zoomOutBtn').onclick = () => { if(scale > 0.4) scale -= 0.2; setTransform(); }
    document.getElementById('zoomResetBtn').onclick = resetZoom;

    container.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY * -0.001;
      const newScale = Math.min(Math.max(.5, scale + delta), 4);
      scale = newScale;
      setTransform();
    });

    container.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startX = e.clientX - pointX;
      startY = e.clientY - pointY;
      panning = true;
    });

    container.addEventListener('mouseup', () => { panning = false; });
    container.addEventListener('mouseleave', () => { panning = false; });

    container.addEventListener('mousemove', (e) => {
      if (!panning) return;
      e.preventDefault();
      pointX = e.clientX - startX;
      pointY = e.clientY - startY;
      setTransform();
    });
    
    container.addEventListener('touchstart', (e) => {
      if(e.touches.length === 1) {
          startX = e.touches[0].clientX - pointX;
          startY = e.touches[0].clientY - pointY;
          panning = true;
      }
    });
    container.addEventListener('touchend', () => { panning = false; });
    container.addEventListener('touchmove', (e) => {
       if(!panning) return;
       if(scale > 1) e.preventDefault(); 
       pointX = e.touches[0].clientX - startX;
       pointY = e.touches[0].clientY - startY;
       setTransform();
    });

  </script>
</body>
</html>
