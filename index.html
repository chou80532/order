<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>台中點餐系統 (雙功能菜單版)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    /* 樣式區 */
    :root { --primary-color: #7c9cbf; --primary-dark: #5e86a9; --secondary-color: #f6ae99; --accent-color: #98c9b2; --background-color: #f9f9f9; --card-bg: #ffffff; --text-color: #4a4a4a; --text-light: #8b99a6; --border-color: #e9ecef; --success-color: #98c9b2; --danger-color: #e5989b; --shadow: 0 8px 30px rgba(0, 0, 0, 0.04); --radius: 20px; --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: 0.3s; }
    .fullscreen-overlay.active { opacity: 1; visibility: visible; }
    .fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; }
    .close-fullscreen { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; width: 50px; height: 50px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.6; background-color: var(--background-color); color: var(--text-color); }
    .container { max-width: 1320px; margin: 0 auto; padding: 40px 20px; }
    header { display: flex; flex-direction: column; align-items: center; margin-bottom: 50px; }
    .app-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; text-align: center; }
    #datetime { font-size: 1.1rem; color: var(--text-light); padding: 8px 20px; background: var(--card-bg); border-radius: 30px; box-shadow: var(--shadow); }
    .content-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 35px; margin-bottom: 45px; }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; border: 1px solid rgba(230, 230, 230, 0.5); }
    .card-header { display: flex; align-items: center; margin-bottom: 25px; }
    .card-icon { font-size: 1.7rem; color: var(--primary-color); margin-right: 15px; background: rgba(124, 156, 191, 0.1); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .card-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin: 0; }
    .form-group { margin-bottom: 22px; }
    label { display: block; margin-bottom: 8px; color: var(--text-light); }
    input, textarea, select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 14px; font-size: 1rem; background: var(--background-color); }
    .btn { padding: 14px 24px; border: none; border-radius: 16px; font-size: 1rem; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 10px; }
    .btn-icon { margin-right: 10px; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-3px); }
    .btn-secondary { background: var(--secondary-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    
    /* 相簿顯示區 */
    .menu-display-area {
      position: relative;
      background: #f3f4f6;
      border-radius: var(--radius);
      min-height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      margin-bottom: 15px;
      border: 1px solid #eee;
    }
    .menu-display-area img {
      max-width: 100%;
      max-height: 600px;
      object-fit: contain;
      cursor: pointer;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      transition: 0.2s;
      z-index: 10;
    }
    .nav-btn:hover { background: var(--primary-color); }
    .nav-prev { left: 10px; }
    .nav-next { right: 10px; }
    
    .page-indicator { text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--primary-color); }
    
    .menu-actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 15px;
      border: 1px solid #eee;
    }
    .action-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 25px; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background: var(--primary-color); color: white; }
    .checkbox-cell { text-align: center; width: 40px; }
    .paid-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--success-color); }
    .total-section { display: flex; justify-content: flex-end; margin: 25px 0; }
    #totalPrice { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); background: var(--card-bg); padding: 12px 25px; border-radius: 20px; box-shadow: var(--shadow); }
    .glass-effect { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; }
    .toast { padding: 16px 24px; border-radius: 18px; margin-bottom: 16px; color: white; box-shadow: 0 8px 30px rgba(0,0,0,0.1); animation: slideIn 0.3s ease forwards; background: rgba(152, 201, 178, 0.9); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @media (max-width: 768px) { .content-wrapper { grid-template-columns: 1fr; } table { font-size: 0.9rem; } th, td { padding: 8px; } .action-row { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="app-title">台中點餐系統 <span style="font-size:0.5em; background:#f6c177; color:white; padding:4px 8px; border-radius:10px; vertical-align:middle;">雙功能版</span></h1>
      <div id="datetime" class="glass-effect"></div>
    </header>

    <div class="content-wrapper">
      <div class="card glass-effect">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-utensils"></i></div>
          <h2 class="card-title">我要點餐</h2>
        </div>
        <form id="orderForm">
          <div class="form-group"><label>您的姓名</label><input type="text" id="name" required placeholder="例如：小明"></div>
          <div class="form-group"><label>餐點名稱</label><input type="text" id="meal" required placeholder="例如：珍奶半糖微冰"></div>
          <div class="form-group"><label>價格</label><input type="number" id="price" required placeholder="例如：60"></div>
          <div class="form-group"><label>備註</label><textarea id="note" rows="2" placeholder="備註事項"></textarea></div>
          <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane btn-icon"></i>送出訂單</button>
        </form>
      </div>

      <div class="card glass-effect">
        <div class="card-header">
          <div class="card-icon"><i class="fas fa-clipboard-list"></i></div>
          <h2 class="card-title">今日菜單</h2>
        </div>
        
        <div class="menu-display-area">
            <button class="nav-btn nav-prev" onclick="prevMenuPage()"><i class="fas fa-chevron-left"></i></button>
            <img id="currentMenuImg" src="" alt="菜單" style="display:none;" />
            <div id="noMenuText" style="color: #8b99a6; text-align: center;">暫無菜單<br>請使用下方任一種方式新增</div>
            <button class="nav-btn nav-next" onclick="nextMenuPage()"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div id="pageIndicator" class="page-indicator">第 0 / 0 頁</div>
        
        <div style="text-align:center; margin-bottom:15px;">
             <button id="deleteCurrentPageBtn" class="btn btn-danger btn-sm" style="display:none; width:auto;" onclick="deleteCurrentMenuPage()">
                <i class="fas fa-trash-alt btn-icon"></i>刪除目前顯示的這頁
            </button>
        </div>

        <div class="menu-actions">
            <div style="font-size:0.9rem; font-weight:bold; color:#7c9cbf;">新增菜單方式 1：貼上網址 (無大小限制)</div>
            <div class="action-row">
                <input type="text" id="menuUrlInput" placeholder="請貼上圖片連結 (https://...)" style="flex:2;">
                <button id="addUrlBtn" class="btn btn-primary" style="flex:1; margin-bottom:0;">
                    <i class="fas fa-link btn-icon"></i>新增網址
                </button>
            </div>

            <div style="border-top:1px dashed #ddd; margin: 5px 0;"></div>

            <div style="font-size:0.9rem; font-weight:bold; color:#7c9cbf;">新增菜單方式 2：電腦上傳 (限950KB)</div>
            <div class="action-row">
                <button id="changeImageButton" class="btn btn-secondary" style="width:100%; margin-bottom:0;">
                    <i class="fas fa-upload btn-icon"></i>選擇圖片上傳
                </button>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
        </div>
      </div>
    </div>

    <div class="card glass-effect">
      <div class="card-header">
        <div class="card-icon"><i class="fas fa-list-alt"></i></div>
        <h2 class="card-title">大家點了什麼</h2>
      </div>
      <div style="overflow-x:auto;">
        <table id="orderTable">
          <thead>
            <tr>
              <th class="checkbox-cell">選</th>
              <th>No.</th>
              <th>已繳費</th>
              <th>姓名</th>
              <th>餐點</th>
              <th>價格</th>
              <th>時間</th>
              <th>備註</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="total-section">
        <div id="totalPrice">總金額: $0</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="exportButton" class="btn btn-primary" style="flex:1;">匯出 Excel</button>
        <button id="deleteSelectedButton" class="btn btn-secondary" style="flex:1;">刪除選取</button>
        <button id="clearButton" class="btn btn-danger" style="flex:1;">全部清空</button>
      </div>
    </div>
  </div>

  <div class="toast-container"></div>
  <div id="fullscreenOverlay" class="fullscreen-overlay">
    <img id="fullscreenImage" class="fullscreen-image" src="" />
    <div id="closeFullscreen" class="close-fullscreen"><i class="fas fa-times"></i></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQ6dico4o8QYUTEwqPs378QG5D3o_4htc",
      authDomain: "taichung-order.firebaseapp.com",
      projectId: "taichung-order",
      storageBucket: "taichung-order.firebasestorage.app",
      messagingSenderId: "366278670573",
      appId: "1:366278670573:web:fc1762da58ed7b7b4434e4",
      measurementId: "G-WR6L5NHZE6"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      console.log("Firebase 連線成功");
      showToast("系統連線成功！");
      listenToOrders();
      listenToMenuImages(); 
    } catch (e) {
      console.error(e);
      alert("連線失敗！" + e.message);
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = now.toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
      });
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // 訂單邏輯
    function listenToOrders() {
      const db = firebase.firestore();
      db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        const tbody = document.querySelector('#orderTable tbody');
        tbody.innerHTML = '';
        let total = 0;
        let index = snapshot.docs.length; 
        snapshot.docs.forEach((doc) => {
          const data = doc.data();
          const row = tbody.insertRow(0);
          
          let timeStr = "";
          if(data.timestamp){
            const dateObj = new Date(data.timestamp);
            timeStr = dateObj.toLocaleString('zh-TW', {month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false});
          }

          row.innerHTML = `
            <td class="checkbox-cell"><input type="checkbox" data-id="${doc.id}"></td>
            <td>${index--}</td>
            <td style="text-align:center;">
              <input type="checkbox" class="paid-checkbox" ${data.paid ? 'checked' : ''} onchange="togglePaid('${doc.id}', this.checked)">
            </td>
            <td>${data.name}</td>
            <td>${data.meal}</td>
            <td>$${data.price}</td>
            <td style="font-size:0.9em; color:#666;">${timeStr}</td>
            <td style="color:#888; font-size:0.9em;">${data.note || ''}</td>
          `;
          total += Number(data.price);
        });
        document.getElementById('totalPrice').textContent = `總金額: $${total}`;
      });
    }

    document.getElementById('orderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const db = firebase.firestore();
      db.collection("orders").add({
        name: document.getElementById('name').value,
        meal: document.getElementById('meal').value,
        price: Number(document.getElementById('price').value),
        note: document.getElementById('note').value,
        paid: false,
        timestamp: Date.now()
      }).then(() => {
        document.getElementById('orderForm').reset();
        showToast("訂單已送出！");
      }).catch(err => alert("送出失敗: " + err.message));
    });

    window.togglePaid = function(id, isPaid) {
      firebase.firestore().collection("orders").doc(id).update({ paid: isPaid });
    }

    // 相簿邏輯
    let menuDataList = [];
    let currentMenuIndex = 0;

    function listenToMenuImages() {
      firebase.firestore().collection("menu_images").orderBy("timestamp", "asc").onSnapshot(snapshot => {
        menuDataList = [];
        snapshot.forEach(doc => {
          menuDataList.push({ id: doc.id, ...doc.data() });
        });
        
        if (currentMenuIndex >= menuDataList.length) {
          currentMenuIndex = Math.max(0, menuDataList.length - 1);
        }
        
        renderCurrentMenu();
      });
    }

    function renderCurrentMenu() {
      const imgEl = document.getElementById('currentMenuImg');
      const noText = document.getElementById('noMenuText');
      const indicator = document.getElementById('pageIndicator');
      const delBtn = document.getElementById('deleteCurrentPageBtn');

      if (menuDataList.length === 0) {
        imgEl.style.display = 'none';
        imgEl.src = '';
        noText.style.display = 'block';
        indicator.textContent = '第 0 / 0 頁';
        delBtn.style.display = 'none';
      } else {
        const data = menuDataList[currentMenuIndex];
        imgEl.src = data.url;
        imgEl.style.display = 'block';
        noText.style.display = 'none';
        indicator.textContent = `第 ${currentMenuIndex + 1} / ${menuDataList.length} 頁`;
        delBtn.style.display = 'inline-block';
      }
    }

    window.prevMenuPage = function() {
      if (menuDataList.length > 0) {
        currentMenuIndex = (currentMenuIndex - 1 + menuDataList.length) % menuDataList.length;
        renderCurrentMenu();
      }
    }

    window.nextMenuPage = function() {
      if (menuDataList.length > 0) {
        currentMenuIndex = (currentMenuIndex + 1) % menuDataList.length;
        renderCurrentMenu();
      }
    }

    window.deleteCurrentMenuPage = function() {
      if (menuDataList.length === 0) return;
      const pwd = prompt("請輸入密碼");
      if (pwd !== '22913577') return alert("密碼錯誤");

      const docId = menuDataList[currentMenuIndex].id;
      firebase.firestore().collection("menu_images").doc(docId).delete()
        .then(() => showToast("已刪除此頁菜單"))
        .catch(err => alert("刪除失敗: " + err.message));
    }

    // ★★★ 方式 1：新增網址 ★★★
    document.getElementById('addUrlBtn').addEventListener('click', () => {
        const url = document.getElementById('menuUrlInput').value;
        if (!url) return alert("請先貼上網址！");
        
        showToast("新增網址中...", "info");
        firebase.firestore().collection("menu_images").add({
            url: url,
            timestamp: Date.now()
        })
        .then(() => {
            showToast("網址圖片新增成功！");
            document.getElementById('menuUrlInput').value = '';
            currentMenuIndex = menuDataList.length; // 跳到最新那張
        })
        .catch(err => alert("新增失敗: " + err.message));
    });

    // ★★★ 方式 2：上傳圖片 ★★★
    document.getElementById('changeImageButton').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 950 * 1024) { 
        alert("圖片超過 950KB！請改用「貼上網址」功能，或是先壓縮圖片再上傳。");
        return;
      }

      showToast("圖片上傳中...", "info");
      const reader = new FileReader();
      reader.onload = function(event) {
        const base64String = event.target.result; 
        firebase.firestore().collection("menu_images").add({
          url: base64String,
          timestamp: Date.now()
        })
        .then(() => { 
            showToast("上傳成功！"); 
            currentMenuIndex = menuDataList.length; 
        })
        .catch(err => alert("上傳失敗: " + err.message));
      };
      reader.readAsDataURL(file);
    });

    // 刪除選取
    document.getElementById('deleteSelectedButton').addEventListener('click', () => {
      const checks = document.querySelectorAll('#orderTable input[type="checkbox"]:checked');
      if (checks.length === 0) return alert("請先勾選要刪除的項目");
      const pwd = prompt("請輸入密碼");
      if (pwd !== '22913577') return alert("密碼錯誤");
      const batch = firebase.firestore().batch();
      checks.forEach(chk => {
        batch.delete(firebase.firestore().collection("orders").doc(chk.dataset.id));
      });
      batch.commit().then(() => showToast("刪除成功"));
    });

    // 全部清空
    document.getElementById('clearButton').addEventListener('click', () => {
      if (!confirm("確定要清空所有訂單嗎？")) return;
      const pwd = prompt("請輸入密碼");
      if (pwd !== '22913577') return alert("密碼錯誤");
      firebase.firestore().collection("orders").get().then(snapshot => {
        const batch = firebase.firestore().batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      }).then(() => showToast("全部清空成功"));
    });

    // 匯出 Excel
    document.getElementById('exportButton').addEventListener('click', () => {
      let csv = "\uFEFFNo.,已繳費,姓名,餐點,價格,時間,備註\n"; 
      const rows = document.querySelectorAll('#orderTable tbody tr');
      let i = rows.length;
      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        const paid = cols[2].querySelector('input').checked ? '是' : '否';
        csv += `${i--},${paid},${cols[3].innerText},${cols[4].innerText},${cols[5].innerText},${cols[6].innerText},${cols[7].innerText}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `orders_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    });

    function showToast(msg) {
      const container = document.querySelector('.toast-container');
      const div = document.createElement('div');
      div.className = 'toast';
      div.innerText = msg;
      container.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    document.getElementById('currentMenuImg').addEventListener('click', function() {
      if(this.src) {
        document.getElementById('fullscreenImage').src = this.src;
        document.getElementById('fullscreenOverlay').classList.add('active');
      }
    });
    document.getElementById('closeFullscreen').addEventListener('click', () => {
      document.getElementById('fullscreenOverlay').classList.remove('active');
    });
  </script>
</body>
</html>
